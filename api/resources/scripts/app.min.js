var prcJQuery = jQuery.noConflict();

prcJQuery(document).ready(function () {
    // sorting reviews data
    prcJQuery('.ekomi_reviews_sort').on('change', function (e) {
        prcFilter = this.value;
        prcOffset = 0;
        var data = {
            storeHash: storeHash,
            prcProductId: prcProductId,
            queryBy: queryBy,
            prcOffset: prcOffset,
            reviewsLimit: reviewsLimit,
            prcFilter: prcFilter
        };

        prcJQuery.ajax({
            type: "POST",
            url: ajaxUrl + 'loadReviews',
            data: data,
            cache: false,
            success: function (data) {
                var json = prcJQuery.parseJSON(data);

                prcJQuery('#ekomi_reviews_container').html(json.result);

                // reset the page offset

                reviewsCountPage = json.count;

                prcJQuery('.current_review_batch').text(reviewsCountPage);
                prcJQuery('.loads_more_reviews').show();
            }
        });
    });

    // saving users feedback on reviews
    prcJQuery('body').on('click', '.ekomi_review_helpful_button', function () {
        var current = prcJQuery(this);

        var data = {
            storeHash: storeHash,
            prcProductId: prcProductId,
            review_id: prcJQuery(this).data('review-id'),
            helpfulness: prcJQuery(this).data('review-helpfulness')
        };

        prcJQuery.ajax({
            type: "POST",
            url: ajaxUrl + 'saveFeedback',
            data: data,
            cache: false,
            success: function (data) {
                var json = prcJQuery.parseJSON(data);

                current.parent('.ekomi_review_helpful_question').hide();
                current.parent().prev('.ekomi_review_helpful_thankyou').show();
                current.parent().prev().prev('.ekomi_review_helpful_info').html(json.message);
            }
        });
    });

    // Loading reviews on paginatin
    prcJQuery('body').on('click', '.loads_more_reviews', function (e) {
        prcOffset = reviewsCountPage;

        if (reviewsCountTotal / reviewsCountPage > 1) {
            var data = {
                storeHash: storeHash,
                prcProductId: prcProductId,
                queryBy: queryBy,
                prcOffset: prcOffset,
                reviewsLimit: reviewsLimit,
                prcFilter: prcFilter
            };

            prcJQuery.ajax({
                type: "POST",
                url: ajaxUrl + 'loadReviews',
                data: data,
                cache: false,
                success: function (data) {
                    var json = prcJQuery.parseJSON(data);

                    reviewsCountPage = reviewsCountPage + json.count;
                    prcJQuery('#ekomi_reviews_container').append(json.result);
                    prcJQuery('.current_review_batch').text(reviewsCountPage);

                    if (reviewsCountTotal / reviewsCountPage <= 1) {
                        prcJQuery('.loads_more_reviews').hide();
                    }
                }
            });
        } else {
            prcJQuery('.loads_more_reviews').hide();
        }
    });
});
